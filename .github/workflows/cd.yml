name: CD - Deploy to VM

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
      deploy-path:
        required: true
        type: string
      has-database:
        required: false
        type: boolean
        default: false
      build-args:
        required: false
        type: string
        default: ""
        description: "Docker build arguments (one per line, KEY=VALUE format)"
    secrets:
      SERVICE_PORT:
        required: true
      ENV_VARS:
        required: true
      BUILD_ARGS:
        required: false
        description: "Docker build arguments with secrets (one per line, KEY=VALUE format)"
      OCTOPUS_SSH_PRIVATE_KEY:
        required: true
      OCTOPUS_VM_HOST:
        required: true
      OCTOPUS_VM_USER:
        required: true

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Build & Push Image
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # Build with optional build args
          BUILD_ARGS=""

          # Add build args from inputs (non-secret)
          if [ -n "${{ inputs.build-args }}" ]; then
            while IFS= read -r arg; do
              [ -n "$arg" ] && BUILD_ARGS="$BUILD_ARGS --build-arg $arg"
            done <<< "${{ inputs.build-args }}"
          fi

          # Add build args from secrets
          if [ -n "${{ secrets.BUILD_ARGS }}" ]; then
            while IFS= read -r arg; do
              [ -n "$arg" ] && BUILD_ARGS="$BUILD_ARGS --build-arg $arg"
            done <<< "${{ secrets.BUILD_ARGS }}"
          fi

          docker build $BUILD_ARGS -t ghcr.io/${{ github.repository }}:latest .
          docker push ghcr.io/${{ github.repository }}:latest

      - name: Deploy to VM
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OCTOPUS_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan -H ${{ secrets.OCTOPUS_VM_HOST }} >> ~/.ssh/known_hosts

          ssh -i ~/.ssh/key ${{ secrets.OCTOPUS_VM_USER }}@${{ secrets.OCTOPUS_VM_HOST }} << 'EOF'
            cd ${{ inputs.deploy-path }}

            # Criar .env
            cat > .env << 'ENVEOF'
          ${{ secrets.ENV_VARS }}
          ENVEOF

            # Login e deploy
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ghcr.io/${{ github.repository }}:latest
            docker-compose down || true
            docker-compose up -d

            # Migrations se necessÃ¡rio
            ${{ inputs.has-database && 'sleep 5 && docker-compose exec -T $(docker-compose ps --services | head -n 1) npx prisma migrate deploy' || 'echo "Skipping migrations"' }}
          EOF

          rm -f ~/.ssh/key

      - name: Health Check
        run: |
          sleep 15
          for i in {1..10}; do
            curl -f http://${{ secrets.OCTOPUS_VM_HOST }}:${{ secrets.SERVICE_PORT }}/api/health && exit 0
            sleep 5
          done
          exit 1
