name: CD - Deploy to VM

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
      service-port:
        required: true
        type: string
      deploy-path:
        required: true
        type: string
      has-database:
        required: false
        type: boolean
        default: false
    secrets:
      ENV_VARS:
        required: true

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Build & Push Image
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker build -t ghcr.io/${{ github.repository }}:latest .
          docker push ghcr.io/${{ github.repository }}:latest

      - name: Deploy to VM
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

          ssh -i ~/.ssh/key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            cd ${{ inputs.deploy-path }}

            # Criar .env
            cat > .env << 'ENVEOF'
          ${{ secrets.ENV_VARS }}
          ENVEOF

            # Login e deploy
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ghcr.io/${{ github.repository }}:latest
            docker-compose down || true
            docker-compose up -d

            # Migrations se necessÃ¡rio
            ${{ inputs.has-database && 'sleep 5 && docker-compose exec -T $(docker-compose ps --services | head -n 1) npx prisma migrate deploy' || 'echo "Skipping migrations"' }}
          EOF

          rm -f ~/.ssh/key

      - name: Health Check
        run: |
          sleep 15
          for i in {1..10}; do
            curl -f http://${{ secrets.VM_HOST }}:${{ inputs.service-port }}/api/health && exit 0
            sleep 5
          done
          exit 1
